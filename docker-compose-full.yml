version: '3.8'

services:
  # ==================== 基础设施 ====================
  consul:
    image: consul:1.15
    container_name: deploy-consul
    ports:
      - "8500:8500"
    command: agent -server -bind=0.0.0.0 -client=0.0.0.0 -bootstrap-expect=1 -ui

  mysql:
    image: mysql:8.0
    container_name: deploy-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
    volumes:
      - ./deploy/mysql-init:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7.0
    container_name: deploy-redis
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3.11-management
    container_name: go-ecommerce-rabbitmq
    ports:
      - "5672:5672" # 应用连接端口
      - "15672:15672" # 管理界面端口
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    restart: always

  # ==================== 微服务 ====================
  user-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/user
    container_name: go-ecommerce-user-service
    depends_on:
      - consul
      - mysql
    ports:
      - "50051:50051"
    environment:
      - SERVICE_NAME=user-service
      - SERVICE_PORT=50051
      - CONSUL_ADDRESS=consul:8500
      - MYSQL_DSN=root:root@tcp(mysql:3306)/db_user?charset=utf8mb4&parseTime=True&loc=Local

  product-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/product
    container_name: go-ecommerce-product-service
    depends_on:
      - consul
      - mysql
    ports:
      - "50052:50052"
    environment:
      - SERVICE_NAME=product-service
      - SERVICE_PORT=50052
      - CONSUL_ADDRESS=consul:8500
      - MYSQL_DSN=root:root@tcp(mysql:3306)/db_product?charset=utf8mb4&parseTime=True&loc=Local

  cart-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/cart
    container_name: go-ecommerce-cart-service
    depends_on:
      - consul
      - redis
    ports:
      - "50053:50053"
    environment:
      - SERVICE_NAME=cart-service
      - SERVICE_PORT=50053
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379

  order-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/order
    container_name: go-ecommerce-order-service
    depends_on:
      - consul
      - mysql
      - rabbitmq
    ports:
      - "50054:50054"
    environment:
      - SERVICE_NAME=order-service
      - SERVICE_PORT=50054
      - CONSUL_ADDRESS=consul:8500
      # [新增] RabbitMQ 连接
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      # [新增] 确保数据库连接正确 (适配代码中的 os.Getenv)
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      # 兼容旧代码读取 DSN
      - MYSQL_DSN=root:root@tcp(mysql:3306)/db_order?charset=utf8mb4&parseTime=True&loc=Local

  payment-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/payment
    container_name: go-ecommerce-payment-service
    depends_on:
      - consul
      - order-service
    ports:
      - "50055:50055"
    environment:
      - SERVICE_NAME=payment-service
      - SERVICE_PORT=50055
      - CONSUL_ADDRESS=consul:8500

  address-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/address
    container_name: go-ecommerce-address-service-1
    ports:
      - "50056:50056"
    depends_on:
      - mysql
      - consul
    environment:
      - SERVICE_NAME=address-service
      - SERVICE_PORT=50056
      - CONSUL_ADDRESS=consul:8500
      # 使用分拆配置，防止 :0 错误
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=root
      - MYSQL_DBNAME=db_user
    restart: always

  gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_PATH: apps/gateway
    container_name: go-ecommerce-gateway
    depends_on:
      - consul
      - user-service
      - product-service
      - cart-service
      - order-service
      - address-service
    ports:
      - "8080:8080"
    environment:
      - SERVICE_PORT=8080
      - CONSUL_ADDRESS=consul:8500

volumes:
  mysql_data:
